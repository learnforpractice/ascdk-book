
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../notify/">
      
      
        <link rel="next" href="../crypto/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.4">
    
    
      
        <title>Database Operations - Rust Smart Contracts Development Cook Book</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.240905d7.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#database-operations" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Rust Smart Contracts Development Cook Book" class="md-header__button md-logo" aria-label="Rust Smart Contracts Development Cook Book" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Rust Smart Contracts Development Cook Book
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Database Operations
            
          </span>
        </div>
      </div>
    </div>
    
    
      <div class="md-header__option">
        <div class="md-select">
          
          <button class="md-header__button md-icon" aria-label="Select language">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.52 17.52 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04M18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12m-2.62 7 1.62-4.33L19.12 17h-3.24Z"/></svg>
          </button>
          <div class="md-select__inner">
            <ul class="md-select__list">
              
                <li class="md-select__item">
                  <a href="./" hreflang="en" class="md-select__link">
                    English
                  </a>
                </li>
              
                <li class="md-select__item">
                  <a href="../zh/database/" hreflang="zh" class="md-select__link">
                    中文
                  </a>
                </li>
              
            </ul>
          </div>
        </div>
      </div>
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/learnforpractice/rscdk-book" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Rust Smart Contracts Development Cook Book" class="md-nav__button md-logo" aria-label="Rust Smart Contracts Development Cook Book" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Rust Smart Contracts Development Cook Book
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/learnforpractice/rscdk-book" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../prelude/" class="md-nav__link">
        Prerequisite Knowledge
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../env/" class="md-nav__link">
        Setting Up the Development Environment
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../helloworld/" class="md-nav__link">
        HelloWorld
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../deploy/" class="md-nav__link">
        Deploying a Smart Contract
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../ui/" class="md-nav__link">
        Interact with Digital Wallets
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../action/" class="md-nav__link">
        Use of Inline Actions in Smart Contracts
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../notify/" class="md-nav__link">
        require_recipient Function
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Database Operations
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Database Operations
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#storefindupdate" class="md-nav__link">
    store/find/update
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#removal" class="md-nav__link">
    Removal
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lower_boundupper_bound" class="md-nav__link">
    lower_bound/upper_bound
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-the-api-to-query-the-table" class="md-nav__link">
    Using the API to Query the Table
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#storage-querying-and-updating-of-secondary-indexes" class="md-nav__link">
    Storage, Querying, and Updating of Secondary Indexes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deletion-of-secondary-indexes" class="md-nav__link">
    Deletion of Secondary Indexes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#use-api-to-query-tables-with-secondary-indexes" class="md-nav__link">
    Use API to Query Tables with Secondary Indexes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    Conclusion
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../crypto/" class="md-nav__link">
        Cryptography Related Functions
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../common/" class="md-nav__link">
        Common Smart Contract Functions
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../abi/" class="md-nav__link">
        Detailed Explanation of ABI Types
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../callc/" class="md-nav__link">
        Calling C/C++ Code from Rust
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#storefindupdate" class="md-nav__link">
    store/find/update
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#removal" class="md-nav__link">
    Removal
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lower_boundupper_bound" class="md-nav__link">
    lower_bound/upper_bound
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-the-api-to-query-the-table" class="md-nav__link">
    Using the API to Query the Table
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#storage-querying-and-updating-of-secondary-indexes" class="md-nav__link">
    Storage, Querying, and Updating of Secondary Indexes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deletion-of-secondary-indexes" class="md-nav__link">
    Deletion of Secondary Indexes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#use-api-to-query-tables-with-secondary-indexes" class="md-nav__link">
    Use API to Query Tables with Secondary Indexes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    Conclusion
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="database-operations">Database Operations</h1>
<p>Chain data storage and retrieval are crucial functions of smart contracts. The EOS chain implements a memory database, supporting data storage in table form. Each entry in a table has a unique primary index, also known as a primary key, of the uint64 type. The raw data stored in the table are binary data of any length. When the smart contract invokes the data storage function, it serializes class data and stores it in the table. When reading, it deserializes the raw data back into class objects. It also supports secondary index tables of types uint64, Uint128, Uint256, Float64, Float128, which can be considered special tables with fixed data length. Primary index tables and secondary index tables can work together to implement multi-indexing. A table can have multiple secondary index tables. Secondary index table values can be duplicated, but the primary index of the primary index table must be unique.</p>
<p>Below, we will use an example to explain the use of the EOS chain's in-memory database.</p>
<h2 id="storefindupdate">store/find/update</h2>
<p>Storage, search, and update are the most basic functions of a database. The following code demonstrates how to use these three functions to perform chain counting.</p>
<div class="highlight"><pre><span></span><code><span class="cp">#![cfg_attr(not(feature = </span><span class="s">&quot;std&quot;</span><span class="cp">), no_std)]</span>
<span class="cp">#![cfg_attr(feature = </span><span class="s">&quot;std&quot;</span><span class="cp">, allow(warnings))]</span>

<span class="cp">#[rust_chain::contract]</span>
<span class="k">mod</span> <span class="nn">counter</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">rust_chain</span>::<span class="p">{</span>
<span class="w">        </span><span class="n">Name</span><span class="p">,</span>
<span class="w">        </span><span class="n">chain_println</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="cp">#[chain(table=</span><span class="s">&quot;counter&quot;</span><span class="cp">)]</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Counter</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cp">#[chain(primary)]</span>
<span class="w">        </span><span class="n">account</span>: <span class="nc">Name</span><span class="p">,</span>
<span class="w">        </span><span class="n">count</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[chain(main)]</span>
<span class="w">    </span><span class="cp">#[allow(dead_code)]</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Contract</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">receiver</span>: <span class="nc">Name</span><span class="p">,</span>
<span class="w">        </span><span class="n">first_receiver</span>: <span class="nc">Name</span><span class="p">,</span>
<span class="w">        </span><span class="n">action</span>: <span class="nc">Name</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">impl</span><span class="w"> </span><span class="n">Contract</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">receiver</span>: <span class="nc">Name</span><span class="p">,</span><span class="w"> </span><span class="n">first_receiver</span>: <span class="nc">Name</span><span class="p">,</span><span class="w"> </span><span class="n">action</span>: <span class="nc">Name</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">receiver</span>: <span class="nc">receiver</span><span class="p">,</span>
<span class="w">                </span><span class="n">first_receiver</span>: <span class="nc">first_receiver</span><span class="p">,</span>
<span class="w">                </span><span class="n">action</span>: <span class="nc">action</span><span class="p">,</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="cp">#[chain(action = </span><span class="s">&quot;inc&quot;</span><span class="cp">)]</span>
<span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">inc_count</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">account</span>: <span class="nc">Name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Counter</span>::<span class="n">new_table</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">receiver</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">db</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="n">value</span><span class="p">());</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">payer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">receiver</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="p">.</span><span class="n">get_value</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">value</span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">                </span><span class="n">db</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">it</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">payer</span><span class="p">);</span>
<span class="w">                </span><span class="n">chain_println</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;+++count:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Counter</span><span class="p">{</span><span class="n">account</span>: <span class="nc">account</span><span class="p">,</span><span class="w"> </span><span class="n">count</span>: <span class="mi">1</span><span class="p">};</span>
<span class="w">                </span><span class="n">db</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">payer</span><span class="p">);</span>
<span class="w">                </span><span class="n">chain_println</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;+++count:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Explanation of the code above:</p>
<ul>
<li><code>#[chain(primary)]</code> specifies a primary index member variable as account, of type <code>Name</code>. Note that if the primary index is not of <code>u64</code> type, you need to implement the <code>get_primary</code> method of the <code>rust_chain::db::PrimaryValueInterface</code> trait, as the <code>Name</code> structure has implemented:
<div class="highlight"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">PrimaryValueInterface</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">get_primary</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u64</span> <span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">value</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></li>
<li>The <code>counter</code> module uses the <code>#[rust_chain::contract]</code> to reference the <code>contract</code> macro from the <code>rust_chain</code> package. This macro generates additional code related to database operations and action processing based on the <code>chain</code> attributes in the module.</li>
<li><code>#[chain(table="counter")]</code> uses the <code>chain</code> attribute to define a table named <code>counter</code>, which is a <code>name</code> structure. The <code>table</code> keyword instructs the compiler to generate table-related code, wrapping the <code>MultiIndex</code> structure related code in <code>rust-chain</code> to make it easier for developers to call.</li>
<li><code>#[chain(action = "inc")]</code> indicates that the <code>inc_count</code> method is an <code>action</code>, triggered by the Action structure included in the Transaction.</li>
<li><code>Counter::new_table(self.receiver)</code> creates a table, where <code>self.receiver</code> specifies the name of the current contract account, indicating that the table is stored in the current contract account.</li>
<li><code>let it = db.find(account.value());</code> is used to find the value located at the primary index <code>1</code>, and the returned value is of type <code>Iterator</code>.</li>
<li><code>let Some(mut value) = it.get_value()</code> is used to obtain the value in <code>Iterator</code>. If the value doesn't exist, <code>db.store(&amp;value, payer);</code> is used to save a new value to the database. Otherwise, after incrementing count by 1, <code>db.update(&amp;it, &amp;value, payer);</code> is used to update the data in the database. The payer specifies which account pays for the RAM resources and needs to have signed with the <code>active</code> permission of that account in the Transaction.</li>
</ul>
<p>Compilation:</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>examples/counter
rust-contract<span class="w"> </span>build
</code></pre></div>
<p>Testing:</p>
<div class="highlight"><pre><span></span><code>ipyeos<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>-s<span class="w"> </span>-x<span class="w"> </span>test.py<span class="w"> </span>-k<span class="w"> </span>test_counter
</code></pre></div>
<p>Test code to run is as follows:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@chain_test</span>
<span class="k">def</span> <span class="nf">test_counter</span><span class="p">(</span><span class="n">tester</span><span class="p">:</span> <span class="n">ChainTester</span><span class="p">):</span>
    <span class="n">deploy_contract</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="s1">&#39;counter&#39;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">push_action</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;inc&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;hello&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">})</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;++++++elapsed: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;elapsed&#39;</span><span class="p">])</span>
    <span class="n">tester</span><span class="o">.</span><span class="n">produce_block</span><span class="p">()</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">push_action</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;inc&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;hello&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">})</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;++++++elapsed: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;elapsed&#39;</span><span class="p">])</span>
    <span class="n">tester</span><span class="o">.</span><span class="n">produce_block</span><span class="p">()</span>
</code></pre></div>
<h2 id="removal">Removal</h2>
<p>The code below demonstrates how to delete a piece of data from the database.</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[chain(action = </span><span class="s">&quot;testremove&quot;</span><span class="cp">)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">account</span>: <span class="nc">Name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Counter</span>::<span class="n">new_table</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">receiver</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">db</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="n">value</span><span class="p">());</span>
<span class="w">    </span><span class="n">check</span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">is_ok</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;key not found&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">db</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">it</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>The code above first calls the <code>let it = db.find(account.value());</code> method to find the specified data, then calls <code>remove</code> to delete it, and checks if the specified index's data exists by calling <code>it.is_ok()</code>.</p>
<p><strong>Note:</strong></p>
<p>Here, <code>remove</code> doesn't need the <code>payer</code> account's permission specified by <code>store</code> or <code>update</code> to delete data. Therefore, in actual applications, you need to ensure the specified account's permission by calling <code>rust_chain.require_auth</code>, for example:</p>
<div class="highlight"><pre><span></span><code><span class="n">require_auth</span><span class="p">(</span><span class="n">name</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">))</span>
</code></pre></div>
<p>Test code:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@chain_test</span>
<span class="k">def</span> <span class="nf">test_remove</span><span class="p">(</span><span class="n">tester</span><span class="p">:</span> <span class="n">ChainTester</span><span class="p">):</span>
    <span class="n">deploy_contract</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="s1">&#39;counter&#39;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;account&#39;</span><span class="p">:</span> <span class="s1">&#39;alice&#39;</span><span class="p">}</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">push_action</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;inc&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;hello&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">})</span>
    <span class="n">tester</span><span class="o">.</span><span class="n">produce_block</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">get_table_rows</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;counter&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;+++++++++table rows: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">push_action</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;inc&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;hello&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">})</span>
    <span class="n">tester</span><span class="o">.</span><span class="n">produce_block</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">get_table_rows</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;counter&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;+++++++++table rows: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">push_action</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;testremove&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;hello&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">})</span>
    <span class="n">tester</span><span class="o">.</span><span class="n">produce_block</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">get_table_rows</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;counter&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;+++++++++table rows: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
</code></pre></div>
<p>Here, the <code>inc</code> action is called first to ensure that data is stored in the database. Then, <code>testremove</code> is called to delete the specified data. The <code>get_table_rows</code> function is used to confirm whether the data has been added, modified, or deleted. The usage of <code>get_table_rows</code> will be introduced later.</p>
<p>Compilation:</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>examples/counter
rust-contract<span class="w"> </span>build<span class="w"> </span>.
</code></pre></div>
<p>Testing:</p>
<div class="highlight"><pre><span></span><code>ipyeos<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>-s<span class="w"> </span>-x<span class="w"> </span>test.py<span class="w"> </span>-k<span class="w"> </span>test_remove
</code></pre></div>
<p>Output:</p>
<div class="highlight"><pre><span></span><code>INFO     test:test.py:90 +++++++++table rows: {&#39;rows&#39;: [{&#39;account&#39;: &#39;alice&#39;, &#39;count&#39;: 1}], &#39;more&#39;: False, 
INFO     test:test.py:95 +++++++++table rows: {&#39;rows&#39;: [{&#39;account&#39;: &#39;alice&#39;, &#39;count&#39;: 2}], &#39;more&#39;: False, &#39;next_key&#39;: &#39;&#39;}
INFO     test:test.py:100 +++++++++table rows: {&#39;rows&#39;: [], &#39;more&#39;: False, &#39;next_key&#39;: &#39;&#39;}
</code></pre></div>
<h2 id="lower_boundupper_bound">lower_bound/upper_bound</h2>
<p>These two methods are also used to find elements in the table. Unlike the <code>find</code> method, these two functions are used for fuzzy searches. The <code>lower_bound</code> method returns the <code>Iterator</code> of the first element <code>&gt;=</code> the specified <code>id</code>, and the <code>upper_bound</code> method returns the <code>Iterator</code> of the first element <code>&gt;</code> the specified <code>id</code>. The usage is as follows:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[chain(action = </span><span class="s">&quot;testbound&quot;</span><span class="cp">)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test_bound</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">payer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">receiver</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Counter</span>::<span class="n">new_table</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">receiver</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Counter</span><span class="p">{</span><span class="n">account</span>: <span class="nc">Name</span><span class="p">{</span><span class="n">n</span>: <span class="mi">1</span><span class="p">},</span><span class="w"> </span><span class="n">count</span>: <span class="mi">1</span><span class="p">};</span>
<span class="w">    </span><span class="n">db</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">payer</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Counter</span><span class="p">{</span><span class="n">account</span>: <span class="nc">Name</span><span class="p">{</span><span class="n">n</span>: <span class="mi">3</span><span class="p">},</span><span class="w"> </span><span class="n">count</span>: <span class="mi">1</span><span class="p">};</span>
<span class="w">    </span><span class="n">db</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">payer</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Counter</span><span class="p">{</span><span class="n">account</span>: <span class="nc">Name</span><span class="p">{</span><span class="n">n</span>: <span class="mi">5</span><span class="p">},</span><span class="w"> </span><span class="n">count</span>: <span class="mi">1</span><span class="p">};</span>
<span class="w">    </span><span class="n">db</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">payer</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">db</span><span class="p">.</span><span class="n">lower_bound</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">check</span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">is_ok</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">it</span><span class="p">.</span><span class="n">get_primary</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;bad value&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">chain_println</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;+++++db.lower_bound(1) return primary key:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">it</span><span class="p">.</span><span class="n">get_primary</span><span class="p">().</span><span class="n">unwrap</span><span class="p">());</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">db</span><span class="p">.</span><span class="n">upper_bound</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="w">    </span><span class="n">check</span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">is_ok</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">it</span><span class="p">.</span><span class="n">get_primary</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;bad value&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">chain_println</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;+++++db.upper_bound(3) return primary key:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">it</span><span class="p">.</span><span class="n">get_primary</span><span class="p">().</span><span class="n">unwrap</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div>
<p>Test code:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@chain_test</span>
<span class="k">def</span> <span class="nf">test_bound</span><span class="p">(</span><span class="n">tester</span><span class="p">:</span> <span class="n">ChainTester</span><span class="p">):</span>
    <span class="n">deploy_contract</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="s1">&#39;counter&#39;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">push_action</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;testbound&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;hello&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">})</span>
</code></pre></div>
<p>Compilation:</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>examples/counter
rust-contract<span class="w"> </span>build
</code></pre></div>
<p>Running the test:</p>
<div class="highlight"><pre><span></span><code>ipyeos<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>-s<span class="w"> </span>-x<span class="w"> </span>test.py<span class="w"> </span>-k<span class="w"> </span>test_bound
</code></pre></div>
<p>Output:</p>
<div class="highlight"><pre><span></span><code>+++++db.lower_bound(1) return primary key: 1
+++++db.upper_bound(3) return primary key: 5
</code></pre></div>
<h2 id="using-the-api-to-query-the-table">Using the API to Query the Table</h2>
<p>The above examples are all about how to operate the on-chain database's tables through smart contracts. In fact, the off-chain <code>get_table_rows</code> API interface provided by EOS can also be used to query the tables on the chain. In the <code>ipyeos</code>'s <code>ChainTester</code> class and <code>pyeoskit</code>'s <code>ChainApiAsync</code> and <code>ChainApi</code> classes, the <code>get_table_rows</code> interface is provided to facilitate table query operations.</p>
<p>In Python code, the definition of <code>get_table_rows</code> is as follows:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_table_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_json</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span>
                                <span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span><span class="p">,</span>
                                <span class="n">limit</span><span class="p">,</span>
                                <span class="n">key_type</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                <span class="n">index_position</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                                <span class="n">reverse</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="n">show_payer</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Fetch smart contract data from an account. </span>
<span class="sd">    key_type: &quot;i64&quot;|&quot;i128&quot;|&quot;i256&quot;|&quot;float64&quot;|&quot;float128&quot;|&quot;sha256&quot;|&quot;ripemd160&quot;</span>
<span class="sd">    index_position: &quot;2&quot;|&quot;3&quot;|&quot;4&quot;|&quot;5&quot;|&quot;6&quot;|&quot;7&quot;|&quot;8&quot;|&quot;9&quot;|&quot;10&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
</code></pre></div>
<p>Explanation of this interface's parameters:</p>
<ul>
<li><code>_json</code>: True to return data in JSON format, False to return raw data represented in hexadecimal</li>
<li><code>code</code>: The account where the table is located</li>
<li><code>scope</code>: Usually set as an empty string, when there are the same <code>code</code> and <code>table</code>, different <code>scope</code> can be used to distinguish different tables</li>
<li><code>table</code>: The name of the data table to be queried</li>
<li><code>lower_bound</code>: The starting primary key for the query, either string type or numerical type. When it's a string type, it can represent a <code>name</code> type. If it starts with a hexadecimal string '0x', it represents a numerical type. If it's empty, it means starting the query from the beginning.</li>
<li><code>upper_bound</code>: The ending primary key for the query, either string type or numerical type. When it's a string type, it can represent a <code>name</code> type. If it starts with a hexadecimal string '0x', it represents a numerical type. If it's empty, it means there's no upper limit set, and all values <code>&gt;=</code> <code>lower_bound</code> will be returned.</li>
<li><code>limit</code>: Used to limit the number of returned values</li>
<li><code>key_type</code>: Used to specify the type of index, by default it's a 64-bit unsigned integer type</li>
<li><code>index_position</code>: Used to specify the relative position of the index. Empty or '1' indicates the main index, from '2' and above indicates the position of the secondary index</li>
<li><code>reverse</code>: Specifies whether to return data in reverse order</li>
<li><code>show_payer</code>: Specifies whether to show the account paying for RAM resources</li>
</ul>
<p>To query the table through <code>get_table_rows</code>, the structure of the table must be visible in the ABI description. In the <code>db_example1</code> example, the generated <code>test.abi</code> includes the following information, which is the description of the table:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&quot;tables&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;counter&quot;</span><span class="p">,</span>
<span class="w">       </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Counter&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;index_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;i64&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;key_names&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nt">&quot;key_types&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">]</span>
</code></pre></div>
<p>Test code:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@chain_test</span>
<span class="k">def</span> <span class="nf">test_offchain_find</span><span class="p">(</span><span class="n">tester</span><span class="p">):</span>
    <span class="n">deploy_contract</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="s1">&#39;counter&#39;</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">push_action</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;testbound&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;hello&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">})</span>
    <span class="n">tester</span><span class="o">.</span><span class="n">produce_block</span><span class="p">()</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">get_table_rows</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;counter&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;+++++++rows: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">get_table_rows</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;counter&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;+++++++rows: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">get_table_rows</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;counter&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;+++++++rows: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
</code></pre></div>
<p>Running the test code:</p>
<div class="highlight"><pre><span></span><code>ipyeos<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>-s<span class="w"> </span>-x<span class="w"> </span>test.py<span class="w"> </span>-k<span class="w"> </span>test_offchain_find
</code></pre></div>
<p>Output:</p>
<div class="highlight"><pre><span></span><code>INFO     test:test.py:118 +++++++rows: {&#39;rows&#39;: [&#39;01000000000000000100000000000000&#39;, &#39;03000000000000000100000000000000&#39;, &#39;05000000000000000100000000000000&#39;], &#39;more&#39;: False, &#39;next_key&#39;: &#39;&#39;}
INFO     test:test.py:121 +++++++rows: {&#39;rows&#39;: [{&#39;account&#39;: &#39;............1&#39;, &#39;count&#39;: 1}, {&#39;account&#39;: &#39;............3&#39;, &#39;count&#39;: 1}, {&#39;account&#39;: &#39;............5&#39;, &#39;count&#39;: 1}], &#39;more&#39;: False, &#39;next_key&#39;: &#39;&#39;}
INFO     test:test.py:124 +++++++rows: {&#39;rows&#39;: [{&#39;account&#39;: &#39;............1&#39;, &#39;count&#39;: 1}, {&#39;account&#39;: &#39;............3&#39;, &#39;count&#39;: 1}], &#39;more&#39;: False, &#39;next_key&#39;: &#39;&#39;}
</code></pre></div>
<p>Note that the <code>account</code> here is of the <code>name</code> structure, which converts the numerical value to a string, so the output may appear somewhat odd.</p>
<h2 id="storage-querying-and-updating-of-secondary-indexes">Storage, Querying, and Updating of Secondary Indexes</h2>
<p>First, let's look at the following example:</p>
<p><a href="https://github.com/learnforpractice/rscdk-book/tree/master/examples/secondaryindex">Example Code</a></p>
<div class="highlight"><pre><span></span><code><span class="cp">#![cfg_attr(not(feature = </span><span class="s">&quot;std&quot;</span><span class="cp">), no_std)]</span>
<span class="cp">#![cfg_attr(feature = </span><span class="s">&quot;std&quot;</span><span class="cp">, allow(warnings))]</span>

<span class="cp">#[rust_chain::contract]</span>
<span class="k">mod</span> <span class="nn">secondaryindex</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">rust_chain</span>::<span class="p">{</span>
<span class="w">        </span><span class="n">Name</span><span class="p">,</span>
<span class="w">        </span><span class="n">chain_println</span><span class="p">,</span>
<span class="w">        </span><span class="n">check</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="cp">#[chain(table=</span><span class="s">&quot;mydata&quot;</span><span class="cp">)]</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">MyData</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cp">#[chain(primary)]</span>
<span class="w">        </span><span class="n">a</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">        </span><span class="cp">#[chain(secondary)]</span>
<span class="w">        </span><span class="n">b</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">        </span><span class="cp">#[chain(secondary)]</span>
<span class="w">        </span><span class="n">c</span>: <span class="kt">u128</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[chain(main)]</span>
<span class="w">    </span><span class="cp">#[allow(dead_code)]</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Contract</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">receiver</span>: <span class="nc">Name</span><span class="p">,</span>
<span class="w">        </span><span class="n">first_receiver</span>: <span class="nc">Name</span><span class="p">,</span>
<span class="w">        </span><span class="n">action</span>: <span class="nc">Name</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">impl</span><span class="w"> </span><span class="n">Contract</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">receiver</span>: <span class="nc">Name</span><span class="p">,</span><span class="w"> </span><span class="n">first_receiver</span>: <span class="nc">Name</span><span class="p">,</span><span class="w"> </span><span class="n">action</span>: <span class="nc">Name</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">receiver</span>: <span class="nc">receiver</span><span class="p">,</span>
<span class="w">                </span><span class="n">first_receiver</span>: <span class="nc">first_receiver</span><span class="p">,</span>
<span class="w">                </span><span class="n">action</span>: <span class="nc">action</span><span class="p">,</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="cp">#[chain(action = </span><span class="s">&quot;test1&quot;</span><span class="cp">)]</span>
<span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test1</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyData</span>::<span class="n">new_table</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">receiver</span><span class="p">);</span>

<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">MyData</span><span class="p">{</span><span class="n">a</span>: <span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">c</span>: <span class="mi">3</span><span class="p">};</span>
<span class="w">            </span><span class="n">db</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">receiver</span><span class="p">);</span>

<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">MyData</span><span class="p">{</span><span class="n">a</span>: <span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="mi">22</span><span class="p">,</span><span class="w"> </span><span class="n">c</span>: <span class="mi">33</span><span class="p">};</span>
<span class="w">            </span><span class="n">db</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">receiver</span><span class="p">);</span>

<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">MyData</span><span class="p">{</span><span class="n">a</span>: <span class="mi">111</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="mi">222</span><span class="p">,</span><span class="w"> </span><span class="n">c</span>: <span class="mi">333</span><span class="p">};</span>
<span class="w">            </span><span class="n">db</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">receiver</span><span class="p">);</span>
<span class="w">            </span><span class="n">chain_println</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;++++test1 done!&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="cp">#[chain(action = </span><span class="s">&quot;test2&quot;</span><span class="cp">)]</span>
<span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test2</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">chain_println</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;+++b:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyData</span>::<span class="n">new_table</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">receiver</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">db</span><span class="p">.</span><span class="n">get_idx_by_b</span><span class="p">();</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">it_secondary</span><span class="p">,</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">secondary_value</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idx</span><span class="p">.</span><span class="n">lower_bound</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">it_secondary</span><span class="p">.</span><span class="n">is_ok</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">chain_println</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;++++primary value&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">it_secondary</span><span class="p">.</span><span class="n">primary</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;secondary value:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">secondary_value</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// update secondary value</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">payer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">receiver</span><span class="p">;</span>
<span class="w">                </span><span class="n">secondary_value</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">                </span><span class="n">db</span><span class="p">.</span><span class="n">update_b</span><span class="p">(</span><span class="o">&amp;</span><span class="n">it_secondary</span><span class="p">,</span><span class="w"> </span><span class="n">secondary_value</span><span class="p">,</span><span class="w"> </span><span class="n">payer</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>In this example, two secondary indexes are defined:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[chain(secondary)]</span>
<span class="n">b</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="cp">#[chain(secondary)]</span>
<span class="n">c</span>: <span class="kt">u128</span><span class="p">,</span>
</code></pre></div>
<p>The <code>test1</code> action calls the <code>store</code> method to store 3 sets of data. The <code>test2</code> action demonstrates the use of <code>lower_bound</code> to search for secondary indexes, as well as the use of the generated <code>update_b</code> method to update secondary index data.</p>
<p>Test code:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@chain_test</span>
<span class="k">def</span> <span class="nf">test_secondary</span><span class="p">(</span><span class="n">tester</span><span class="p">):</span>
    <span class="n">deploy_contract</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="s1">&#39;secondaryindex&#39;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">push_action</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;test1&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;hello&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">})</span>
    <span class="n">tester</span><span class="o">.</span><span class="n">produce_block</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">get_table_rows</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;mydata&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;+++++++rows: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">222</span>
    <span class="p">}</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">push_action</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;test2&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;hello&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">})</span>
    <span class="n">tester</span><span class="o">.</span><span class="n">produce_block</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">get_table_rows</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;mydata&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;+++++++rows: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
</code></pre></div>
<p>Compile:</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>examples/secondaryindex
rust-contract<span class="w"> </span>build
</code></pre></div>
<p>Run the test:</p>
<div class="highlight"><pre><span></span><code>ipyeos<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>-s<span class="w"> </span>-x<span class="w"> </span>test.py<span class="w"> </span>-k<span class="w"> </span>test_secondary
</code></pre></div>
<p>Output:</p>
<div class="highlight"><pre><span></span><code>INFO     test:test.py:78 +++++++rows: {&#39;rows&#39;: [{&#39;a&#39;: 1, &#39;b&#39;: 2, &#39;c&#39;: &#39;3&#39;}, {&#39;a&#39;: 11, &#39;b&#39;: 22, &#39;c&#39;: &#39;33&#39;}, {&#39;a&#39;: 111, &#39;b&#39;: 222, &#39;c&#39;: &#39;333&#39;}], &#39;more&#39;: False, &#39;next_key&#39;: &#39;&#39;}
[(hello,test2)-&gt;hello]: CONSOLE OUTPUT BEGIN =====================
+++b: 222
++++primary value 111 secondary value: 222

[(hello,test2)-&gt;hello]: CONSOLE OUTPUT END   =====================
INFO     test:test.py:86 +++++++rows: {&#39;rows&#39;: [{&#39;a&#39;: 1, &#39;b&#39;: 2, &#39;c&#39;: &#39;3&#39;}, {&#39;a&#39;: 11, &#39;b&#39;: 22, &#39;c&#39;: &#39;33&#39;}, {&#39;a&#39;: 111, &#39;b&#39;: 223, &#39;c&#39;: &#39;333&#39;}], &#39;more&#39;: False, &#39;next_key&#39;: &#39;&#39;}
</code></pre></div>
<p>From the output:</p>
<div class="highlight"><pre><span></span><code>{&#39;a&#39;: 111, &#39;b&#39;: 223, &#39;c&#39;: &#39;333&#39;}
</code></pre></div>
<p>It can be seen that 222 has been changed to 223, while other values remain unchanged.</p>
<h2 id="deletion-of-secondary-indexes">Deletion of Secondary Indexes</h2>
<div class="highlight"><pre><span></span><code><span class="cp">#[chain(action = </span><span class="s">&quot;test3&quot;</span><span class="cp">)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test3</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">chain_println</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;+++b:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyData</span>::<span class="n">new_table</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">receiver</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">db</span><span class="p">.</span><span class="n">get_idx_by_b</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idx</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
<span class="w">    </span><span class="n">check</span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">is_ok</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;b not found&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">primary_it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">db</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">primary</span><span class="p">);</span>
<span class="w">    </span><span class="n">check</span><span class="p">(</span><span class="n">primary_it</span><span class="p">.</span><span class="n">is_ok</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;primary key not found&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">db</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">primary_it</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idx</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
<span class="w">    </span><span class="n">check</span><span class="p">(</span><span class="o">!</span><span class="n">it</span><span class="p">.</span><span class="n">is_ok</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;b shoud not exit now&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>The code above can be explained as follows:</p>
<ul>
<li><code>let it = idx.find(b);</code> searches for the secondary index.</li>
<li><code>let primary_it = db.find(it.primary);</code> gets the primary index through <code>it.primary</code>, and returns the iterator of the primary index.</li>
<li><code>db.remove(&amp;primary_it);</code> removes the element from the table, including the primary index and all secondary indexes.</li>
</ul>
<p>From the example above, it can be seen that the deletion of secondary indexes first finds the primary index through the secondary index, and then deletes it through the primary index.</p>
<p>Test code:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@chain_test</span>
<span class="k">def</span> <span class="nf">test_remove</span><span class="p">(</span><span class="n">tester</span><span class="p">):</span>
    <span class="n">deploy_contract</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="s1">&#39;secondaryindex&#39;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">push_action</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;test1&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;hello&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">})</span>
    <span class="n">tester</span><span class="o">.</span><span class="n">produce_block</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">get_table_rows</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;mydata&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;+++++++rows: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">222</span>
    <span class="p">}</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">push_action</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;test3&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;hello&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">})</span>
    <span class="n">tester</span><span class="o">.</span><span class="n">produce_block</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">get_table_rows</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;mydata&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;+++++++rows: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
</code></pre></div>
<p>Compile:</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>examples/secondaryindex
go-contract<span class="w"> </span>build<span class="w"> </span>.
</code></pre></div>
<p>Run the test:</p>
<div class="highlight"><pre><span></span><code>ipyeos<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>-s<span class="w"> </span>-x<span class="w"> </span>test.py<span class="w"> </span>-k<span class="w"> </span>test_remove
</code></pre></div>
<p>Output:</p>
<div class="highlight"><pre><span></span><code>INFO     test:test.py:96 +++++++rows: {&#39;rows&#39;: [{&#39;a&#39;: 1, &#39;b&#39;: 2, &#39;c&#39;: &#39;3&#39;}, {&#39;a&#39;: 11, &#39;b&#39;: 22, &#39;c&#39;: &#39;33&#39;}, {&#39;a&#39;: 111, &#39;b&#39;: 222, &#39;c&#39;: &#39;333&#39;}], &#39;more&#39;: False, &#39;next_key&#39;: &#39;&#39;}
[(hello,test3)-&gt;hello]: CONSOLE OUTPUT BEGIN =====================
+++b: 222
[(hello,test3)-&gt;hello]: CONSOLE OUTPUT END   =====================
INFO     test:test.py:104 +++++++rows: {&#39;rows&#39;: [{&#39;a&#39;: 1, &#39;b&#39;: 2, &#39;c&#39;: &#39;3&#39;}, {&#39;a&#39;: 11, &#39;b&#39;: 22, &#39;c&#39;: &#39;33&#39;}], &#39;more&#39;: False, &#39;next_key&#39;: &#39;&#39;}
</code></pre></div>
<p>Comparing the return values of the two <code>get_table_rows</code>, it can be seen that the data set <code>{'a': 111, 'b': 222, 'c': '333'}</code> has been deleted.</p>
<h2 id="use-api-to-query-tables-with-secondary-indexes">Use API to Query Tables with Secondary Indexes</h2>
<p>In the examples above, two secondary indexes were defined, of types <code>u64</code> and <code>u128</code> respectively. The <code>get_table_rows</code> API also supports finding corresponding values through secondary indexes.</p>
<div class="highlight"><pre><span></span><code><span class="nd">@chain_test</span>
<span class="k">def</span> <span class="nf">test_offchain_find</span><span class="p">(</span><span class="n">tester</span><span class="p">:</span> <span class="n">ChainTester</span><span class="p">):</span>
    <span class="n">deploy_contract</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="s1">&#39;secondaryindex&#39;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">push_action</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;test1&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;hello&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">})</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">get_table_rows</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;mydata&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">key_type</span><span class="o">=</span><span class="s2">&quot;i64&quot;</span><span class="p">,</span> <span class="n">index_position</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;+++++++rows: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">get_table_rows</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;mydata&#39;</span><span class="p">,</span> <span class="s1">&#39;11&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">key_type</span><span class="o">=</span><span class="s2">&quot;i64&quot;</span><span class="p">,</span> <span class="n">index_position</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;+++++++rows: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
    <span class="c1"># 0x14d == 333</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">get_table_rows</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;mydata&#39;</span><span class="p">,</span> <span class="s1">&#39;0x14d&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">key_type</span><span class="o">=</span><span class="s2">&quot;i128&quot;</span><span class="p">,</span> <span class="n">index_position</span><span class="o">=</span><span class="s2">&quot;3&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;+++++++rows: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
</code></pre></div>
<p><strong>Note</strong>, when querying <code>c</code>, because its type is <code>u128</code>, for values beyond the range of <code>u64</code> type, you can use hexadecimal to represent the data. For example, the hexadecimal <code>0x14d</code> is <code>333</code> in decimal.</p>
<p>Run the test case:</p>
<div class="highlight"><pre><span></span><code>ipyeos<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>-s<span class="w"> </span>-x<span class="w"> </span>test.py<span class="w"> </span>-k<span class="w"> </span>test_offchain_find
</code></pre></div>
<p>The output of the test code above is as follows:
<div class="highlight"><pre><span></span><code>INFO     test:test.py:113 +++++++rows: {&#39;rows&#39;: [{&#39;a&#39;: 1, &#39;b&#39;: 2, &#39;c&#39;: &#39;3&#39;}, {&#39;a&#39;: 11, &#39;b&#39;: 22, &#39;c&#39;: &#39;33&#39;}, {&#39;a&#39;: 111, &#39;b&#39;: 222, &#39;c&#39;: &#39;333&#39;}], &#39;more&#39;: False, &#39;next_key&#39;: &#39;&#39;}
INFO     test:test.py:116 +++++++rows: {&#39;rows&#39;: [{&#39;a&#39;: 11, &#39;b&#39;: 22, &#39;c&#39;: &#39;33&#39;}, {&#39;a&#39;: 111, &#39;b&#39;: 222, &#39;c&#39;: &#39;333&#39;}], &#39;more&#39;: False, &#39;next_key&#39;: &#39;&#39;}
INFO     test:test.py:119 +++++++rows: {&#39;rows&#39;: [{&#39;a&#39;: 111, &#39;b&#39;: 222, &#39;c&#39;: &#39;333&#39;}], &#39;more&#39;: False, &#39;next_key&#39;: &#39;&#39;}
</code></pre></div></p>
<h2 id="conclusion">Conclusion</h2>
<p>The data storage function in EOS is quite robust, and it has the feature of secondary index tables, which makes data search very flexible. This chapter provides a detailed explanation of the code for adding, deleting, updating, and querying database tables. This chapter contains a lot of content and will take some time to digest. You can make some changes based on the examples and try to run them to enhance your understanding of the knowledge points in this chapter.</p>
<p><a href="https://github.com/learnforpractice/rscdk-book/tree/master/examples/counter">Example Code 1</a>
<a href="https://github.com/learnforpractice/rscdk-book/tree/master/examples/secondaryindex">Example Code 2</a></p>





  <h2 id="__comments">Comments</h2>
  <!-- Insert generated snippet here -->
  <script src="https://giscus.app/client.js"
  data-repo="learnforpractice/rscdk-book"
  data-repo-id="R_kgDOJjgWNQ"
  data-category="Q&A"
  data-category-id="DIC_kwDOJjgWNc4CWwNt"
  data-mapping="title"
  data-strict="0"
  data-reactions-enabled="1"
  data-emit-metadata="0"
  data-input-position="bottom"
  data-theme="preferred_color_scheme"
  data-lang="en"
  crossorigin="anonymous"
  async>
  </script>

  <!-- Synchronize Giscus theme with palette -->
  <script>
    var giscus = document.querySelector("script[src*=giscus]")

    /* Set palette on initial load */
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
      var theme = palette.color.scheme === "slate" ? "dark" : "light"
      giscus.setAttribute("data-theme", theme) 
    }

    /* Register event handlers after documented loaded */
    // document.addEventListener("DOMContentLoaded", function() {
    //   var ref = document.querySelector("[data-md-component=palette]")
    //   ref.addEventListener("change", function() {
    //     var palette = __md_get("__palette")
    //     if (palette && typeof palette.color === "object") {
    //       var theme = palette.color.scheme === "slate" ? "dark" : "light"

    //       /* Instruct Giscus to change theme */
    //       var frame = document.querySelector(".giscus-frame")
    //       frame.contentWindow.postMessage(
    //         { giscus: { setConfig: { theme } } },
    //         "https://giscus.app"
    //       )
    //     }
    //   })
    // })
  </script>

                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.19047be9.min.js"></script>
      
    
  </body>
</html>